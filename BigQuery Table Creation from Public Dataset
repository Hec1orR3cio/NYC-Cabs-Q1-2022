#standardSQL
CREATE OR REPLACE TABLE nyc_cabs_project.yellow_trips_Q1_2022
 OPTIONS(
   description="A extract of the cleaned data from public dataset of new_york_taxi_trips.tlc_yellow_trips for Q1 2022"
 ) AS
SELECT 
pickup_datetime, 
pickup_location_id,
dropoff_datetime,
dropoff_location_id, 
CASE WHEN rate_code = '1.0' 
       THEN 'Standard rate'
     WHEN rate_code = '2.0'
       THEN 'JFK'
     WHEN rate_code = '3.0'
       THEN 'Newark'
     WHEN rate_code = '4.0'
       THEN 'Nassau or Westchester'
     WHEN rate_code = '5.0'
       THEN 'Negociated'
     WHEN rate_code = '6.0'
       THEN 'Group ride'
     ELSE 'Unknown'
END AS rate_type,
passenger_count,
trip_distance,
total_amount,
COALESCE(tip_amount, 0) AS tip_amount,
CASE WHEN payment_type = '1' 
       THEN 'Credit Card'
     WHEN payment_type = '2'
       THEN 'Cash'
     WHEN payment_type = '3'
       THEN 'No charge'
     WHEN payment_type = '4'
       THEN 'Dispute'
     WHEN payment_type = '6'
       THEN 'Voided Trip'
     ELSE 'Unknown'
END AS payment_type
FROM
  `bigquery-public-data.new_york_taxi_trips.tlc_yellow_trips_2022`
WHERE 
  -- Dates for trips occurred in Q1
  pickup_datetime >= '2022-01-01 00:00:00 UTC' 
  AND dropoff_datetime <='2022-03-31 23:59:59 UTC'
  -- Handling wrong dates
  AND pickup_datetime < dropoff_datetime
  AND pickup_datetime IS NOT NULL
  AND dropoff_datetime IS NOT NULL 
  -- Getting rid of NULL location ids and ids that have no values in taxi_geo_data.csv
  AND pickup_location_id IS NOT NULL AND pickup_location_id NOT IN ("264","265")
  AND dropoff_location_id IS NOT NULL AND dropoff_location_id NOT IN ("264","265")
  -- Getting rid of NULL values and making sure number of passenger per trip and trip distance are greater than 0
  AND passenger_count IS NOT NULL AND passenger_count > 0
  AND trip_distance IS NOT NULL AND trip_distance > 0
  -- Getting rid of NULL rate_code and payment_type values
  AND rate_code IS NOT NULL
  AND payment_type IS NOT NULL 
  --There could be negative total_amount values because there is a 'Dispute' payment_type
  AND total_amount IS NOT NULL 
ORDER BY pickup_datetime;
